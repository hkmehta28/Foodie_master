<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Foodie</title>

  <!-- favicon -->
  <link rel="shortcut icon" href="../favicon.svg" type="image/svg+xml">

  <!-- custom css link -->
  <!-- custom css link -->
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/auth.css">

  <!-- google font link -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Rubik:wght@400;500;600;700&family=Shadows+Into+Light&display=swap"
    rel="stylesheet">
    

</head>

<body id="top">

  <div class="auth-container">
    <!-- Left Side: Visual -->
    <div class="auth-visual">
      <div class="auth-visual-content">
        <h2 class="visual-title">Welcome Back!</h2>
        <p class="visual-text">
          "People who love to eat are always the best people." - Julia Child
          <br>Login to access your orders and favorites.
        </p>
      </div>
    </div>

    <!-- Right Side: Form -->
    <div class="auth-form-side">
      <a href="../index.html" class="back-home">
        <ion-icon name="arrow-back-outline"></ion-icon> Back to Home
      </a>

      <div class="auth-form-wrapper">
        <div class="logo-wrapper">
          <a href="../index.html" class="logo-text">Foodie<span>.</span></a>
        </div>

        <div class="form-header">
          <h3 class="form-title">Login to Account</h3>
          <p class="form-subtitle">Enter your credentials to access your account</p>
        </div>

        <div id="msg" class="error-banner"></div>

        <form id="login-form" onsubmit="return false;">
          <div class="custom-input-group">
            <label for="email" class="custom-label">Email Address</label>
            <input type="email" id="email" placeholder="name@example.com" class="custom-input" required>
          </div>

          <div class="custom-input-group">
            <label for="password" class="custom-label">Password</label>
            <input type="password" id="password" placeholder="••••••••" class="custom-input" required>
          </div>

          <button type="submit" id="login-btn" class="submit-btn">Sign In</button>
        </form>

        <div class="form-footer">
          <p>Don't have an account? <a href="./signup.html" class="highlight-link">Sign Up</a></p>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-top" style="background-image: url('../assets/images/footer-illustration.png')">
      <div class="container">
        <div class="footer-brand">
          <a href="../index.html" class="logo">Foodie<span class="span">.</span></a>
          <p class="footer-text">
            Financial experts support or help you to to find out which way you can raise your funds more.
          </p>
        </div>
      </div>
    </div>
    
    <div class="footer-bottom">
      <div class="container">
        <p class="copyright-text">
          &copy; 2022 <a href="#" class="copyright-link">codewithsadee</a> All Rights Reserved.
        </p>
      </div>
    </div>
  </footer>

  <!-- SCRIPTS -->
  <script src="../assets/js/script.js"></script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
  
  <script>
    const API_BASE_URL = "http://localhost:4000";
    
    // Simple script.js toggle doesn't work well outside index structure sometimes if classes differ, 
    // ensuring nav toggle works
    const navTogglers = document.querySelectorAll("[data-menu-toggle-btn]");
    const navbar = document.querySelector("[data-navbar]");
    
    const toggleNavbar = function () {
        navbar.classList.toggle("active");
        document.body.classList.toggle("active");
    }

    addEventOnElem(navTogglers, "click", toggleNavbar);

    // Login Logic
    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = document.getElementById("login-btn");
      const msg = document.getElementById("msg");
      
      msg.style.display = "none";
      btn.disabled = true;
      btn.textContent = "Logging in...";
      
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      try {
        const res = await fetch(`${API_BASE_URL}/api/users/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        
        if (!res.ok) {
          throw new Error(data.message || "Login failed");
        }

        localStorage.setItem("userToken", data.data.token);
        localStorage.setItem("user", JSON.stringify(data.data.user));
        
        btn.textContent = "Success!";
        setTimeout(() => {
        // Explicitly construct path to index.html using string manipulation
        const href = window.location.href;
        const authIndex = href.lastIndexOf('/auth/');
        if (authIndex !== -1) {
             let baseUrl = href.substring(0, authIndex);
             if (window.location.protocol === 'file:' && !baseUrl.includes('/frontend')) {
                  baseUrl += '/frontend';
             }
             window.location.href = baseUrl + '/index.html';
        } else {
             window.location.href = "../index.html";
        }
        }, 500);
        
      } catch (err) {
        msg.textContent = err.message;
        msg.style.display = "block";
        btn.disabled = false;
        btn.textContent = "Login";
      }
    });

    /**
     * add event on element helper (from script.js potentially, but inline defined to be safe)
     */
    function addEventOnElem(elem, type, callback) {
        if (elem.length > 1) {
            for (let i = 0; i < elem.length; i++) {
                elem[i].addEventListener(type, callback);
            }
        } else {
            elem.addEventListener(type, callback);
        }
    }
  </script>
  
  <script src="../assets/js/auth.js"></script>

</body>
</html>
