<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Checkout - Foodie</title>
  <!-- Auth Guard -->
  <script src="./assets/js/auth-guard.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./assets/css/style.css" />
  <link rel="stylesheet" href="./assets/css/checkout.css" />
</head>
<body>
  <div class="checkout-wrapper">
    <div class="page-header">
      <h1 class="page-title">Checkout</h1>
      <p class="page-subtitle">Review your items and confirm delivery details</p>
    </div>

    <div class="checkout-grid">
      <!-- Left Column: Delivery Form -->
      <div class="checkout-column">
        <div class="checkout-card">
          <h2 class="card-title">Order Details</h2>

          <!-- Order Type Selector -->
          <div class="order-type-selector">
            <div class="order-option active" onclick="setOrderType('delivery')">Home Delivery</div>
            <div class="order-option" onclick="setOrderType('takeaway')">Takeaway</div>
            <div class="order-option" onclick="setOrderType('dinein')">Dine-in</div>
          </div>
          
          <div class="form-row">
            <label class="input-label">Full Name</label>
            <input id="customer-name" type="text" class="input-field" placeholder="John Doe">
          </div>
          
          <div class="form-row">
            <label class="input-label">Email Address</label>
            <input id="customer-email" type="email" class="input-field" placeholder="john@example.com">
          </div>
          
          <div class="form-row">
            <label class="input-label">Phone Number</label>
            <input id="customer-phone" type="tel" class="input-field" placeholder="+1 234 567 890">
          </div>
          
          <!-- Delivery Specific -->
          <div id="delivery-fields" class="form-section">
            <div class="form-row">
              <label class="input-label">Delivery Address</label>
              <input id="customer-address" type="text" class="input-field" placeholder="123 Street Name, City">
            </div>
          </div>

          <!-- Takeaway/Dine-in Specific (Time) -->
          <div id="time-fields" class="form-section hidden-field">
            <div class="form-row">
              <label class="input-label" id="time-label">Pickup Time</label>
              <input id="order-time" type="time" class="input-field">
            </div>
          </div>

          <!-- Dine-in Specific -->
          <div id="dinein-fields" class="form-section hidden-field">
            <div class="form-row">
              <label class="input-label">Number of Guests</label>
              <input id="guest-count" type="number" min="1" class="input-field" placeholder="e.g. 2">
            </div>
          </div>

          <div id="checkout-msg" class="error-banner"></div>
        </div>

        <div class="checkout-card">
          <h2 class="card-title">Important Notes</h2>
          <p style="font-size: 0.9rem; color: #666;">
            By placing the order you confirm that the details are correct. 
            Payment will be collected upon delivery/pickup.
          </p>
          <div class="guest-notice">
            If you want to save your order history, please <a href="./auth/login.html">Login</a> or <a href="./auth/signup.html">Sign up</a>.
          </div>
        </div>
      </div>

      <!-- Right Column: Order Summary -->
      <div class="checkout-column">
        <div class="checkout-card summary-card">
          <h2 class="card-title">Order Summary</h2>
          
          <div id="order-container">
            <table class="items-table">
              <thead>
                <tr>
                  <th width="60%">Item</th>
                  <th width="20%" style="text-align: center;">Qty</th>
                  <th width="20%" style="text-align: right;">Price</th>
                </tr>
              </thead>
              <tbody id="items-tbody">
                <!-- Javascript will inject rows here -->
              </tbody>
            </table>

            <div id="empty-cart" style="text-align: center; padding: 20px; color: #666; display: none;">
              Your cart is empty. <br> <a href="./index.html" style="color: var(--deep-saffron); margin-top: 10px; display: inline-block;">Browse Menu</a>
            </div>

            <div id="summary" style="display: none;">
              <div class="summary-row">
                <span>Subtotal</span>
                <span id="subtotal-amt">₹0.00</span>
              </div>
              <div class="summary-row">
                <span>Delivery Fee</span>
                <span id="delivery-amt">₹0.00</span>
              </div>
              
              <div class="summary-total">
                <span>Total</span>
                <span id="total-amt">₹0.00</span>
              </div>

              <button id="place-order-btn" class="place-order-btn">Place Order</button>
            </div>
            
            <a href="./index.html" id="back-btn" class="back-btn">Continue Shopping</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- scripts -->
  <!-- auth.js provides getToken(), getUser(), autofillCheckout() etc. -->
  <script src="./assets/js/auth.js"></script>

  <script>
    // ------- checkout page JS -------
    const CART_KEYS = ["cart", "foodie_cart", "my_cart"]; // look for common keys
    function readCartFromStorage() {
      for (const k of CART_KEYS) {
        const s = localStorage.getItem(k);
        if (!s) continue;
        try {
          const parsed = JSON.parse(s);
          if (Array.isArray(parsed)) return { items: parsed, key: k };
          // maybe stored as { items: [...], total: x }
          if (parsed.items && Array.isArray(parsed.items)) return { items: parsed.items, key: k };
        } catch (e) {
          console.warn("Cart parse error for", k, e);
        }
      }
      return { items: [], key: null };
    }

    function currency(x) {
      return "₹" + Number(x).toFixed(2);
    }

    function renderCart() {
      const { items } = readCartFromStorage();
      const tbody = document.getElementById("items-tbody");
      const empty = document.getElementById("empty-cart");
      const summary = document.getElementById("summary");
      tbody.innerHTML = "";

      if (!items || items.length === 0) {
        empty.style.display = "block";
        summary.style.display = "none";
        return;
      }

      empty.style.display = "none";
      summary.style.display = "block";

      let subtotal = 0;
      items.forEach((it, idx) => {
        // default shape: { id, name, price, quantity }
        const qty = Number(it.quantity || it.qty || 1);
        const price = Number(it.price || it.unitPrice || 0);
        const row = document.createElement("tr");

        // Column 1: Item Details + Unit Price
        const tdName = document.createElement("td");
        tdName.innerHTML = `
        <div class="item-meta">
          ${it.imageUrl ? `<img src="${it.imageUrl}" class="item-img" />` : '<div class="item-img"></div>'}
          <div class="item-info">
            <h4>${it.name}</h4>
            <div class="item-price">${currency(price)}</div>
          </div>
        </div>`;

        // Column 2: Quantity Controls
        const tdQty = document.createElement("td");
        tdQty.style.textAlign = "center";
        tdQty.innerHTML = `
          <div class="qty-control" style="margin: 0 auto;">
            <button onclick="updateQuantity(${idx}, -1)" class="qty-btn">-</button>
            <span class="qty-val">${qty}</span>
            <button onclick="updateQuantity(${idx}, 1)" class="qty-btn">+</button>
          </div>
        `;

        // Column 3: Subtotal
        const tdSub = document.createElement("td");
        tdSub.className = "item-subtotal";
        tdSub.textContent = currency(qty * price);

        row.appendChild(tdName);
        row.appendChild(tdQty);
        row.appendChild(tdSub);

        tbody.appendChild(row);

        subtotal += qty * price;
      });

      // Simple flat delivery fee logic
      // Only charge delivery fee if order type is 'delivery'
      const delivery = (typeof currentOrderType !== 'undefined' && currentOrderType === 'delivery' && subtotal > 0 && subtotal < 500) ? 30 : 0;
      
      document.getElementById("subtotal-amt").textContent = currency(subtotal);
      document.getElementById("delivery-amt").textContent = currency(delivery);
      document.getElementById("total-amt").textContent = currency(subtotal + delivery);
    }

    // Order Type Logic
    let currentOrderType = 'delivery'; // default

    function setOrderType(type) {
        currentOrderType = type;
        
        // Update UI Tabs
        document.querySelectorAll('.order-option').forEach(opt => opt.classList.remove('active'));
        // Find button by text content is tricky, let's use onclick attribute search or index. 
        // Better: renderCart re-calcs delivery fee.
        
        // Simple UI update based on index/text (Mapping: delivery=0, takeaway=1, dinein=2)
        const opts = document.querySelectorAll('.order-option');
        if(type === 'delivery') opts[0].classList.add('active');
        if(type === 'takeaway') opts[1].classList.add('active');
        if(type === 'dinein') opts[2].classList.add('active');

        // Show/Hide Fields
        const delFields = document.getElementById('delivery-fields');
        const timeFields = document.getElementById('time-fields');
        const dineFields = document.getElementById('dinein-fields');
        const timeLabel = document.getElementById('time-label');

        if (type === 'delivery') {
            delFields.style.display = 'block';
            timeFields.style.display = 'none';
            dineFields.style.display = 'none';
        } else if (type === 'takeaway') {
            delFields.style.display = 'none';
            timeFields.style.display = 'block';
            dineFields.style.display = 'none';
            timeLabel.textContent = "Pickup Time";
        } else if (type === 'dinein') {
            delFields.style.display = 'none';
            timeFields.style.display = 'block';
            dineFields.style.display = 'block';
            timeLabel.textContent = "Arrival Time";
        }

        renderCart(); // Recalculate totals (remove delivery fee)
    }

    // placeOrder: sends order to backend
    async function placeOrder() {
      const placeBtn = document.getElementById("place-order-btn");
      const msgEl = document.getElementById("checkout-msg");
      if (msgEl) { msgEl.style.display = "none"; msgEl.textContent = ""; }

      // collect form fields
      const name = document.getElementById("customer-name")?.value.trim() || "";
      const phone = document.getElementById("customer-phone")?.value.trim() || "";
      const email = document.getElementById("customer-email")?.value.trim() || "";
      
      // Conditional fields
      const address = document.getElementById("customer-address")?.value.trim() || "";
      const time = document.getElementById("order-time")?.value || "";
      const guests = document.getElementById("guest-count")?.value.trim() || "";

      // Validation
      if (!name || !phone) {
        if (msgEl) { msgEl.textContent = "Please fill in your name and phone number."; msgEl.style.display = "block"; }
        return;
      }

      if (currentOrderType === 'delivery' && !address) {
         if (msgEl) { msgEl.textContent = "Please enter a delivery address."; msgEl.style.display = "block"; }
         return;
      }

      if ((currentOrderType === 'takeaway' || currentOrderType === 'dinein') && !time) {
         if (msgEl) { msgEl.textContent = `Please select a ${currentOrderType === 'takeaway' ? 'pickup' : 'arrival'} time.`; msgEl.style.display = "block"; }
         return;
      }

      const { items, key } = readCartFromStorage();
      if (!items || items.length === 0) {
        if (msgEl) { msgEl.textContent = "Your cart is empty."; msgEl.style.display = "block"; }
        return;
      }

      // compute totals
      let subtotal = 0;
      const normalizedItems = items.map(it => {
        const qty = Number(it.quantity || it.qty || 1);
        const price = Number(it.price || it.unitPrice || 0);
        subtotal += qty * price;
        return { menuItem: it._id || it.id, name: it.name, price, quantity: qty };
      });

      // Delivery Fee logic: Only for 'delivery'
      const delivery = (currentOrderType === 'delivery' && subtotal > 0 && subtotal < 500) ? 30 : 0;
      const totalAmount = subtotal + delivery;

      // build payload
      const payload = {
        items: normalizedItems,
        totalAmount,
        customerName: name,
        phone,
        email,
        address: currentOrderType === 'delivery' ? address : `[${currentOrderType.toUpperCase()}]`, // Mark as non-delivery
        orderType: currentOrderType, // Add backend field if supported, or pack into notes/address
        pickupTime: time,
        numberOfGuests: guests
      };

      // token from auth.js
      const token = window.auth?.getToken ? window.auth.getToken() : localStorage.getItem("userToken");
      const headers = { "Content-Type": "application/json" };
      if (token) headers["Authorization"] = `Bearer ${token}`;

      try {
        placeBtn.disabled = true;
        placeBtn.textContent = "Placing...";

        const res = await fetch("http://localhost:4000/api/orders", {
          method: "POST",
          headers,
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (!res.ok) {
          console.error("Order error:", data);
          if (msgEl) { msgEl.textContent = data.message || data.detail || "Order failed"; msgEl.style.display = "block"; }
          placeBtn.disabled = false;
          placeBtn.textContent = "Place Order";
          return;
        }

        // success
        for (const k of CART_KEYS) localStorage.removeItem(k);
        window.location.href = "/frontend/my-order.html";
      } catch (err) {
        console.error("Place order error:", err);
        if (msgEl) { msgEl.textContent = "Failed to place order"; msgEl.style.display = "block"; }
      } finally {
        placeBtn.disabled = false;
        placeBtn.textContent = "Place Order";
      }
    }

      document.addEventListener("DOMContentLoaded", () => {
      try { window.auth?.autofillCheckout(); } catch(e) {}
      renderCart();
      
      // Initialize view
      setOrderType('delivery');

      const placeBtn = document.getElementById("place-order-btn");
      if (placeBtn) placeBtn.addEventListener("click", (e) => {
        e.preventDefault();
        placeOrder();
      });

      const back = document.getElementById("back-btn");
      if (back) back.addEventListener("click", (e) => { e.preventDefault(); window.location.href = "./index.html"; });

      window.addEventListener("cartUpdated", renderCart);
    });

    // New function to update quantity
    function updateQuantity(index, delta) {
      const { items, key } = readCartFromStorage();
      if (!items || !items[index]) return;

      const currentQty = Number(items[index].quantity || items[index].qty || 1);
      const newQty = currentQty + delta;

      if (newQty <= 0) {
        if (confirm("Remove this item from cart?")) {
          items.splice(index, 1);
        } else {
          return; // Cancelled
        }
      } else {
        items[index].quantity = newQty;
        // fallback for other schemas
        items[index].qty = newQty;
      }

      // Save back
      if (key) {
        localStorage.setItem(key, JSON.stringify(items));
      } else {
        // default to "cart" if no key found (rare)
        localStorage.setItem("cart", JSON.stringify(items));
      }

      // Dispatch event for navbar
      window.dispatchEvent(new Event("cartUpdated"));
      
      // Re-render
      renderCart();
    }
  </script>
  <script src="./assets/js/nav.js"></script>

</body>
</html>
